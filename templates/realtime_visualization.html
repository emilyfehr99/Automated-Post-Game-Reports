<!DOCTYPE html>
<html>
<head>
    <title>Real-time Hockey Player Tracking</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }
        .main-panel {
            flex: 2;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .side-panel {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls {
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .metrics-table th, .metrics-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .metrics-table th {
            background-color: #f8f9fa;
        }
        .control-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .control-button:hover {
            background-color: #0056b3;
        }
        .control-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.stopped {
            background-color: #dc3545;
            color: white;
        }
        .status.processing {
            background-color: #28a745;
            color: white;
        }
        .status.paused {
            background-color: #ffc107;
            color: black;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom-color: #007bff;
            background-color: #f8f9fa;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .frame-image {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .tracking-container {
            position: relative;
            display: inline-block;
        }
        .rink-image {
            width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .player-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%);
        }
        .player-label {
            position: absolute;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            transform: translate(-50%, -100%);
            margin-top: -5px;
        }
        .slider-container {
            margin: 10px 0;
        }
        .slider {
            width: 100%;
            margin: 10px 0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        .info-item {
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .info-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-panel">
            <h1>Real-time Hockey Player Tracking</h1>
            
            <div class="controls">
                <button class="control-button" id="playPause">▶</button>
                <button class="control-button" id="resetVideo">Reset</button>
                <div class="status stopped" id="status">Stopped</div>
                <div style="margin-left: auto;">
                    <span>FPS: <span id="videoFps">0</span></span>
                    <span style="margin-left: 20px;">Frame: <span id="frameNumber">0</span></span>
                </div>
            </div>

            <div class="slider-container">
                <input type="range" id="frameSlider" class="slider" min="0" max="100" value="0">
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('original')">Original Frame</div>
                <div class="tab" onclick="switchTab('detections')">Player Detections</div>
                <div class="tab" onclick="switchTab('tracking')">Player Tracking</div>
                <div class="tab" onclick="switchTab('team')">Team Detection</div>
            </div>

            <div id="original" class="tab-content active">
                <img id="originalFrame" class="frame-image" src="" alt="Original frame">
            </div>

            <div id="detections" class="tab-content">
                <div style="position: relative; display: inline-block;">
                    <img id="detectionsFrame" class="frame-image" src="" alt="Player detections">
                    <div id="detectionsRinkOverlay" style="position: absolute; bottom: 20px; left: 20px; width: 300px; height: 150px; background: rgba(0, 0, 0, 0.7); border-radius: 8px; border: 2px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                        <div style="position: relative; width: 100%; height: 100%;">
                            <img id="detectionsRinkImage" src="/static/rink_resized.png" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; object-fit: contain; border-radius: 6px;">
                            <div id="detectionsPlayerMarkers" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tracking" class="tab-content">
                <div class="tracking-container">
                    <img id="rinkImage" class="rink-image" src="/static/rink_resized.png" alt="Hockey rink">
                    <div id="playerMarkers"></div>
                </div>
            </div>

            <div id="team" class="tab-content">
                <h3>Team Distribution</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Team A</div>
                        <div class="info-value" id="teamACount">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Team B</div>
                        <div class="info-value" id="teamBCount">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Unknown</div>
                        <div class="info-value" id="unknownCount">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Home</div>
                        <div class="info-value" id="homeCount">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Away</div>
                        <div class="info-value" id="awayCount">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Total Zone Entries</div>
                        <div class="info-value" id="totalZoneEntries">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="side-panel">
            <h3>Player Metrics</h3>
            <table class="metrics-table" id="metricsTable">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Speed</th>
                        <th>Acceleration</th>
                        <th>Orientation</th>
                        <th>Team</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // Global variables
        let isProcessing = false;
        let isPaused = false;
        let currentFrame = 0;
        let videoFps = 30;
        let frameInterval = 1000 / 30;
        let updateInterval = null;
        let playerZoneHistory = new Set();

        // Function to switch tabs
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Function to update status
        function updateStatus(status) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusElement.className = `status ${status}`;
        }

        // Function to start real-time processing
        async function startProcessing() {
            try {
                console.log('Starting processing...');
                const response = await fetch('/api/start', { method: 'POST' });
                const data = await response.json();
                console.log('Start response:', data);
                
                if (data.status === 'started') {
                    isProcessing = true;
                    isPaused = false;
                    document.getElementById('playPause').textContent = '⏸';
                    updateStatus('processing');
                    console.log('Starting frame updates...');
                    startFrameUpdates();
                }
            } catch (error) {
                console.error('Error starting processing:', error);
            }
        }

        // Function to pause/resume processing
        async function pauseProcessing() {
            try {
                const response = await fetch('/api/pause', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'paused') {
                    isPaused = true;
                    document.getElementById('playPause').textContent = '▶';
                    updateStatus('paused');
                    stopFrameUpdates();
                } else if (data.status === 'resumed') {
                    isPaused = false;
                    document.getElementById('playPause').textContent = '⏸';
                    updateStatus('processing');
                    startFrameUpdates();
                }
            } catch (error) {
                console.error('Error pausing/resuming processing:', error);
            }
        }

        // Function to stop processing
        async function stopProcessing() {
            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'stopped') {
                    isProcessing = false;
                    isPaused = false;
                    document.getElementById('playPause').textContent = '▶';
                    updateStatus('stopped');
                    stopFrameUpdates();
                }
            } catch (error) {
                console.error('Error stopping processing:', error);
            }
        }

        // Function to start frame updates
        function startFrameUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            // Use a slower frame rate for smoother playback (30 FPS instead of 59.94)
            const playbackInterval = 1000 / 30; // 30 FPS
            updateInterval = setInterval(updateFrame, playbackInterval);
        }

        // Function to stop frame updates
        function stopFrameUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // Function to update frame with real-time data
        async function updateFrame() {
            if (!isProcessing || isPaused) {
                console.log('Not processing or paused');
                return;
            }
            
            try {
                console.log('Fetching frame...');
                const response = await fetch('/api/frame');
                const frameData = await response.json();
                console.log('Frame data received:', frameData);
                
                if (frameData.frame_id !== undefined) {
                    updateFrameImages(frameData);
                    updateMetricsTable(frameData);
                    updateTeamDistribution(frameData);
                    updateZoneEntries(frameData);
                    
                    // Update frame counter
                    currentFrame = frameData.frame_id;
                    document.getElementById('frameNumber').textContent = `Frame: ${currentFrame}`;
                    document.getElementById('frameSlider').value = currentFrame;
                } else {
                    console.log('No frame data available');
                }
            } catch (error) {
                console.error('Error fetching frame:', error);
            }
        }

        // Function to update frame images
        function updateFrameImages(frameData) {
            // Update original frame
            const originalImg = document.getElementById('originalFrame');
            originalImg.src = `data:image/jpeg;base64,${frameData.original_frame_base64}`;
            
            // Update detections frame
            const detectionsImg = document.getElementById('detectionsFrame');
            detectionsImg.src = `data:image/jpeg;base64,${frameData.detections_base64}`;
            
            // Update player markers for both tracking and detections tabs
            updatePlayerMarkers(frameData);
            updateDetectionsPlayerMarkers(frameData);
        }

        // Function to update player markers on rink
        function updatePlayerMarkers(frameData) {
            const playerMarkers = document.getElementById('playerMarkers');
            playerMarkers.innerHTML = '';
            
            if (frameData.players) {
                frameData.players.forEach(player => {
                    // Only show markers for actual players, not pucks, goals, etc.
                    if (player.rink_position && player.type && player.type.toLowerCase() === 'player') {
                        const rx = player.rink_position.x;
                        const ry = player.rink_position.y;

                        // Determine team-based colors
                        const team = player.team || 'Unknown';
                        let markerColor, labelColor;
                        if (team.includes('Team A')) {
                            markerColor = '#ff6b6b';
                            labelColor = '#ff6b6b';
                        } else if (team.includes('Team B')) {
                            markerColor = '#4ecdc4';
                            labelColor = '#4ecdc4';
                        } else {
                            markerColor = '#95a5a6';
                            labelColor = '#95a5a6';
                        }

                        // Create marker element
                        const marker = document.createElement('div');
                        marker.className = 'player-marker';
                        marker.style.left = `${rx}px`;
                        marker.style.top = `${ry}px`;
                        marker.style.backgroundColor = markerColor;

                        // Create label element
                        const label = document.createElement('div');
                        label.className = 'player-label';
                        label.textContent = player.player_id || 'P';
                        label.style.left = `${rx}px`;
                        label.style.top = `${ry}px`;
                        label.style.color = labelColor;

                        playerMarkers.appendChild(marker);
                        playerMarkers.appendChild(label);
                    }
                });
            }
        }

        // Function to update player markers on detections rink overlay
        function updateDetectionsPlayerMarkers(frameData) {
            const playerMarkers = document.getElementById('detectionsPlayerMarkers');
            playerMarkers.innerHTML = '';
            
            if (frameData.players) {
                frameData.players.forEach(player => {
                    if (player.rink_position && player.type && player.type.toLowerCase() === 'player') {
                        // Scale coordinates from 1400x600 rink to 300x150 overlay
                        const scaleX = 300 / 1400;
                        const scaleY = 150 / 600;
                        const rx = player.rink_position.x * scaleX;
                        const ry = player.rink_position.y * scaleY;

                        // Determine team-based colors
                        const team = player.team || 'Unknown';
                        let markerColor, labelColor;
                        if (team.includes('Team A')) {
                            markerColor = '#ff6b6b';
                            labelColor = '#ff6b6b';
                        } else if (team.includes('Team B')) {
                            markerColor = '#4ecdc4';
                            labelColor = '#4ecdc4';
                        } else {
                            markerColor = '#95a5a6';
                            labelColor = '#95a5a6';
                        }

                        // Create marker element (smaller for overlay)
                        const marker = document.createElement('div');
                        marker.className = 'player-marker';
                        marker.style.left = `${rx}px`;
                        marker.style.top = `${ry}px`;
                        marker.style.backgroundColor = markerColor;
                        marker.style.width = '8px';
                        marker.style.height = '8px';

                        // Create label element (smaller for overlay)
                        const label = document.createElement('div');
                        label.className = 'player-label';
                        label.textContent = player.player_id || 'P';
                        label.style.left = `${rx}px`;
                        label.style.top = `${ry}px`;
                        label.style.color = labelColor;
                        label.style.fontSize = '8px';
                        label.style.padding = '1px 3px';

                        playerMarkers.appendChild(marker);
                        playerMarkers.appendChild(label);
                    }
                });
            }
        }

        // Function to update metrics table
        function updateMetricsTable(frameData) {
            const tbody = document.querySelector('#metricsTable tbody');
            tbody.innerHTML = '';
            
            if (frameData.players) {
                frameData.players.forEach(player => {
                    if (player.type && player.type.toLowerCase() === 'player') {
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = player.player_id || 'Unknown';
                        row.insertCell(1).textContent = (player.speed || 0).toFixed(1);
                        row.insertCell(2).textContent = (player.acceleration || 0).toFixed(1);
                        row.insertCell(3).textContent = (player.orientation || 0).toFixed(1);
                        row.insertCell(4).textContent = player.team || 'Unknown';
                    }
                });
            }
        }

        // Function to update team distribution
        function updateTeamDistribution(frameData) {
            if (!frameData.players) return;

            let teamACount = 0;
            let teamBCount = 0;
            let unknownCount = 0;
            let homeCount = 0;
            let awayCount = 0;

            frameData.players.forEach(player => {
                if (player.type && player.type.toLowerCase() === 'player') {
                    const team = player.team || 'Unknown';
                    if (team.includes('Team A')) {
                        teamACount++;
                        homeCount++;
                    } else if (team.includes('Team B')) {
                        teamBCount++;
                        awayCount++;
                    } else {
                        unknownCount++;
                    }
                }
            });

            // Update team distribution
            document.getElementById('teamACount').textContent = teamACount;
            document.getElementById('teamBCount').textContent = teamBCount;
            document.getElementById('unknownCount').textContent = unknownCount;
            
            // Update home/away counts
            document.getElementById('homeCount').textContent = homeCount;
            document.getElementById('awayCount').textContent = awayCount;
        }

        // Function to update zone entries
        function updateZoneEntries(frameData) {
            if (!frameData.players) return;

            // Define zones using actual rink coordinates
            const LEFT_BLUE_LINE_X = 590;  // Left blue line
            const RIGHT_BLUE_LINE_X = 840; // Right blue line

            frameData.players.forEach(player => {
                if (player.rink_position && player.type && player.type.toLowerCase() === 'player') {
                    const x = player.rink_position.x;
                    const playerId = player.player_id || 'unknown';
                    const team = player.team || 'Unknown';
                    
                    // Check for zone entries
                    if (x < LEFT_BLUE_LINE_X) {
                        // Left zone (defensive zone for Team A)
                        const zoneKey = `${playerId}-left`;
                        if (!playerZoneHistory.has(zoneKey)) {
                            playerZoneHistory.add(zoneKey);
                            // Update zone entry counts
                            const totalElement = document.getElementById('totalZoneEntries');
                            const currentTotal = parseInt(totalElement.textContent) || 0;
                            totalElement.textContent = currentTotal + 1;
                            
                            if (team.includes('Team A')) {
                                const teamAElement = document.getElementById('teamAZoneEntries');
                                const currentTeamA = parseInt(teamAElement.textContent) || 0;
                                teamAElement.textContent = currentTeamA + 1;
                            } else if (team.includes('Team B')) {
                                const teamBElement = document.getElementById('teamBZoneEntries');
                                const currentTeamB = parseInt(teamBElement.textContent) || 0;
                                teamBElement.textContent = currentTeamB + 1;
                            }
                        }
                    } else if (x > RIGHT_BLUE_LINE_X) {
                        // Right zone (offensive zone for Team A)
                        const zoneKey = `${playerId}-right`;
                        if (!playerZoneHistory.has(zoneKey)) {
                            playerZoneHistory.add(zoneKey);
                            // Update zone entry counts
                            const totalElement = document.getElementById('totalZoneEntries');
                            const currentTotal = parseInt(totalElement.textContent) || 0;
                            totalElement.textContent = currentTotal + 1;
                            
                            if (team.includes('Team A')) {
                                const teamAElement = document.getElementById('teamAZoneEntries');
                                const currentTeamA = parseInt(teamAElement.textContent) || 0;
                                teamAElement.textContent = currentTeamA + 1;
                            } else if (team.includes('Team B')) {
                                const teamBElement = document.getElementById('teamBZoneEntries');
                                const currentTeamB = parseInt(teamBElement.textContent) || 0;
                                teamBElement.textContent = currentTeamB + 1;
                            }
                        }
                    }
                }
            });
        }

        // Wrap all initialization in DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners
            document.getElementById('playPause').addEventListener('click', () => {
                if (!isProcessing) {
                    startProcessing();
                } else if (isPaused) {
                    pauseProcessing();
                } else {
                    pauseProcessing();
                }
            });

            document.getElementById('resetVideo').addEventListener('click', () => {
                stopProcessing();
                currentFrame = 0;
                document.getElementById('frameNumber').textContent = 'Frame: 0';
                document.getElementById('frameSlider').value = 0;
                playerZoneHistory.clear();
                
                // Reset zone entries
                document.getElementById('totalZoneEntries').textContent = '0';
                document.getElementById('teamAZoneEntries').textContent = '0';
                document.getElementById('teamBZoneEntries').textContent = '0';
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        document.getElementById('playPause').click();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        // Previous frame (if not processing)
                        if (!isProcessing) {
                            currentFrame = Math.max(0, currentFrame - 1);
                            document.getElementById('frameNumber').textContent = `Frame: ${currentFrame}`;
                            document.getElementById('frameSlider').value = currentFrame;
                        }
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        // Next frame (if not processing)
                        if (!isProcessing) {
                            currentFrame = Math.min(1000, currentFrame + 1);
                            document.getElementById('frameNumber').textContent = `Frame: ${currentFrame}`;
                            document.getElementById('frameSlider').value = currentFrame;
                        }
                        break;
                    case 'Home':
                        e.preventDefault();
                        document.getElementById('resetVideo').click();
                        break;
                }
            });

            // Initialize
            updateStatus('stopped');
            
            // Load video info
            fetch('/api/video_info')
                .then(response => response.json())
                .then(data => {
                    if (data.fps) {
                        videoFps = data.fps;
                        frameInterval = 1000 / videoFps;
                        document.getElementById('videoFps').textContent = videoFps.toFixed(1);
                    }
                })
                .catch(error => console.error('Error loading video info:', error));
        });
    </script>
</body>
</html>
