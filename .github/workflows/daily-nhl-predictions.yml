name: Daily NHL Predictions with Edge Data

concurrency:
  group: daily-nhl-predictions
  cancel-in-progress: false

on:
  schedule:
    # 6am Central Time (handles both CST and CDT automatically)
    - cron: '0 12 * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Check Season Resume Date
        run: |
          current_date=$(date +%Y-%m-%d)
          target_date="2026-02-25"
          if [[ "$current_date" < "$target_date" ]]; then
            echo "‚è∏Ô∏è  Olympic Break: Current date $current_date is before resume date $target_date."
            echo "Skipping workflow."
            # Exit with success to avoid failure notification, or error to cancel. 
            # Using exit 0 (success) effectively skips subsequent steps if we put this first,
            # BUT we need to conditionally run the rest. 
            # Easier way: Set an output and use `if` on subsequent steps, OR just exit 0 and stop.
            # However, steps run sequentially. To stop the workflow successfully we can't just exit 0.
            # We will use gh run cancel to stop it "neutral" or just exit 78 (neutral in some contexts) 
            # or simply fail (exit 1) if we want to be sure nothing else runs, but that sends failure email.
            # Best approach: set an env var and use it in `if` condition for all other steps? Too verbose.
            # Alternative: Exit 1 to fail? No.
            # Let's just exit 0 and use a hack? No.
            # Actually, `gh run cancel` requires a token.
            # Let's use the `if` condition on the job level? No, `on` doesn't support date logic.
            # Let's just let it run but do nothing? 
            # We can use circleci-style "halt"? No.
            # Let's just exit 1 (failure) but that's annoying.
            # How about we just dont run anything else?
            # We can set a step output `should_run` and check it in every other step.
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Season Resumed!"
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi
        id: check_date

      - name: Checkout
        if: steps.check_date.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        if: steps.check_date.outputs.should_run == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install pytz requests pandas numpy beautifulsoup4 python-dateutil reportlab pillow matplotlib scikit-learn seaborn xgboost

      - name: Check time window
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          python3 -c "
          import pytz
          from datetime import datetime
          ct = pytz.timezone('US/Central')
          now_ct = datetime.now(ct)
          print('Now (CT):', now_ct.strftime('%Y-%m-%d %H:%M:%S %Z'))
          print('Running daily predictions workflow...')
          "

      - name: Scrape Edge data
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          echo "üèí SCRAPING NHL EDGE DATA"
          echo "Current directory: $(pwd)"
          echo "Contents:"
          ls -la
          echo "Looking for scraper:"
          find . -name "daily_edge_data_scraper.py" -type f
          echo "Running scraper:"
          python3 daily_edge_data_scraper.py

      - name: Validate edge data exists
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          if [ -f "data/nhl_edge_data.json" ]; then
            echo "‚úÖ Edge data file created successfully in data/"
            ls -l data/nhl_edge_data.json
          else
            echo "‚ùå Edge data file not found in data/" && exit 1
          fi

      - name: Generate real team stats
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          echo "üìä GENERATING REAL TEAM STATS"
          echo "Current directory: $(pwd)"
          echo "Running team stats generator..."
          python3 generate_real_team_stats.py
          echo "‚úÖ Team stats generation complete"
          
          # Check if file was created (script saves to parent directory)
          if [ -f "../data/season_2025_2026_team_stats.json" ]; then
            echo "‚úÖ Team stats file created in parent/data directory"
            ls -lh ../data/season_2025_2026_team_stats.json
          elif [ -f "data/season_2025_2026_team_stats.json" ]; then
            echo "‚úÖ Team stats file created in current/data directory"
            ls -lh data/season_2025_2026_team_stats.json
          else
            echo "‚ö†Ô∏è  Team stats file not found - checking for errors"
          fi

      - name: Update game outcomes
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          echo "üìù UPDATING PAST GAME OUTCOMES"
          python3 update_game_outcomes.py

      - name: Retrain XGBoost Model
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          echo "üß† RETRAINING MODEL WITH LATEST RESULTS"
          python3 train_xgboost_model.py
          if [ -f "xgb_nhl_model.json" ]; then
             echo "‚úÖ Model retrained successfully"
          else
             echo "‚ö†Ô∏è Model training failed or didn't save (accuracy threshold not met?)"
          fi

      - name: Run daily predictions
        if: steps.check_date.outputs.should_run == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "üéØ RUNNING DAILY PREDICTIONS WITH META-ENSEMBLE"
          echo "All data collected, now making predictions..."
          python3 daily_prediction_notifier.py

      - name: Commit predictions and edge data changes
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          git config user.email "action@github.com"
          git config user.name "github-actions[bot]"
          
          # Track files to commit
          FILES_TO_COMMIT=""
          
          # Add nhl_edge_data.json if it exists (in data dir)
          if [ -f "data/nhl_edge_data.json" ]; then
            echo "üì¶ Force adding nhl_edge_data.json..."
            git add --force data/nhl_edge_data.json
            FILES_TO_COMMIT="$FILES_TO_COMMIT data/nhl_edge_data.json"
            echo "‚úÖ nhl_edge_data.json added"
          else
            echo "‚ö†Ô∏è  nhl_edge_data.json not found in data/"
          fi
          
          # Add win_probability_predictions_v2.json if it exists (in data dir)
          if [ -f "data/win_probability_predictions_v2.json" ]; then
            echo "üì¶ Adding win_probability_predictions_v2.json..."
            git add --force data/win_probability_predictions_v2.json
            FILES_TO_COMMIT="$FILES_TO_COMMIT data/win_probability_predictions_v2.json"
            echo "‚úÖ win_probability_predictions_v2.json added"
          else
            echo "‚ö†Ô∏è  win_probability_predictions_v2.json not found in data/"
          fi
          
          # Add season_2025_2026_team_stats.json if it exists
          if [ -f "data/season_2025_2026_team_stats.json" ]; then
            echo "üì¶ Adding season_2025_2026_team_stats.json..."
            git add --force data/season_2025_2026_team_stats.json
            FILES_TO_COMMIT="$FILES_TO_COMMIT data/season_2025_2026_team_stats.json"
            echo "‚úÖ season_2025_2026_team_stats.json added"
          else
            echo "‚ö†Ô∏è  season_2025_2026_team_stats.json not found in data/"
          fi

          # Add advanced goalie and team metrics
          if [ -f "data/goalie_stats.json" ]; then
            echo "üì¶ Adding goalie_stats.json..."
            git add --force data/goalie_stats.json
            FILES_TO_COMMIT="$FILES_TO_COMMIT data/goalie_stats.json"
          fi
          if [ -f "data/team_advanced_metrics.json" ]; then
            echo "üì¶ Adding team_advanced_metrics.json..."
            git add --force data/team_advanced_metrics.json
            FILES_TO_COMMIT="$FILES_TO_COMMIT data/team_advanced_metrics.json"
          fi

          # Add XGBoost Model Artifacts
          if [ -f "xgb_nhl_model.json" ]; then
            echo "üì¶ Adding updated XGBoost model..."
            git add --force xgb_nhl_model.json
            FILES_TO_COMMIT="$FILES_TO_COMMIT xgb_nhl_model.json"
          fi
          
          if [ -f "xgb_features.pkl" ]; then
             git add --force xgb_features.pkl
             FILES_TO_COMMIT="$FILES_TO_COMMIT xgb_features.pkl"
          fi
          
          # Commit if there are changes
          if ! git diff --staged --quiet; then
            echo "üìù Committing updated predictions, edge data, and team stats..."
            git commit -m "Update daily NHL predictions, edge data, and team stats - $(date -u +'%Y-%m-%d')"
            echo "‚úÖ Committed:$FILES_TO_COMMIT"
          else
            echo "‚ÑπÔ∏è  No changes to commit (files are up to date)"
          fi
      - name: Push edge data changes
        if: always() && steps.check_date.outputs.should_run == 'true'
        run: |
          # Only push if there are local commits ahead of origin
          git fetch origin main
          AHEAD=$(git rev-list --count origin/main..HEAD || echo 0)
          if [ "$AHEAD" -gt 0 ]; then
            git pull --rebase --autostash origin main
            git push origin HEAD:main
          else
            echo "No edge data changes to push"
          fi
