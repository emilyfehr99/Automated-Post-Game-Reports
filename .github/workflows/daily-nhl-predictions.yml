name: Daily NHL Predictions with Edge Data

concurrency:
  group: daily-nhl-predictions
  cancel-in-progress: false

on:
  schedule:
    # 6am Central Time (handles both CST and CDT automatically)
    - cron: '0 12 * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytz requests pandas numpy beautifulsoup4 python-dateutil reportlab pillow matplotlib scikit-learn seaborn

      - name: Check time window
        run: |
          python3 -c "
          import pytz
          from datetime import datetime
          ct = pytz.timezone('US/Central')
          now_ct = datetime.now(ct)
          print('Now (CT):', now_ct.strftime('%Y-%m-%d %H:%M:%S %Z'))
          print('Running daily predictions workflow...')
          "

      - name: Scrape Edge data
        run: |
          echo "üèí SCRAPING NHL EDGE DATA"
          echo "Current directory: $(pwd)"
          echo "Contents:"
          ls -la
          echo "Looking for scraper:"
          find . -name "daily_edge_data_scraper.py" -type f
          echo "Running scraper:"
          python3 daily_edge_data_scraper.py

      - name: Validate edge data exists
        run: |
          if [ -f "data/nhl_edge_data.json" ]; then
            echo "‚úÖ Edge data file created successfully in data/"
            ls -l data/nhl_edge_data.json
          else
            echo "‚ùå Edge data file not found in data/" && exit 1
          fi

      - name: Generate real team stats
        run: |
          echo "üìä GENERATING REAL TEAM STATS"
          echo "Current directory: $(pwd)"
          echo "Running team stats generator..."
          python3 generate_real_team_stats.py
          echo "‚úÖ Team stats generation complete"
          
          # Check if file was created (script saves to parent directory)
          if [ -f "../data/season_2025_2026_team_stats.json" ]; then
            echo "‚úÖ Team stats file created in parent/data directory"
            ls -lh ../data/season_2025_2026_team_stats.json
          elif [ -f "data/season_2025_2026_team_stats.json" ]; then
            echo "‚úÖ Team stats file created in current/data directory"
            ls -lh data/season_2025_2026_team_stats.json
          else
            echo "‚ö†Ô∏è  Team stats file not found - checking for errors"
          fi

      - name: Run daily predictions
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "üéØ RUNNING DAILY PREDICTIONS WITH META-ENSEMBLE"
          echo "All data collected, now making predictions..."
          python3 daily_prediction_notifier.py

      - name: Commit predictions and edge data changes
        run: |
          git config user.email "action@github.com"
          git config user.name "github-actions[bot]"
          
          # Track files to commit
          FILES_TO_COMMIT=""
          
          # Add nhl_edge_data.json if it exists (in data dir)
          if [ -f "data/nhl_edge_data.json" ]; then
            echo "üì¶ Force adding nhl_edge_data.json..."
            git add --force data/nhl_edge_data.json
            FILES_TO_COMMIT="$FILES_TO_COMMIT data/nhl_edge_data.json"
            echo "‚úÖ nhl_edge_data.json added"
          else
            echo "‚ö†Ô∏è  nhl_edge_data.json not found in data/"
          fi
          
          # Add win_probability_predictions_v2.json if it exists (in data dir)
          if [ -f "data/win_probability_predictions_v2.json" ]; then
            echo "üì¶ Adding win_probability_predictions_v2.json..."
            git add --force data/win_probability_predictions_v2.json
            FILES_TO_COMMIT="$FILES_TO_COMMIT data/win_probability_predictions_v2.json"
            echo "‚úÖ win_probability_predictions_v2.json added"
          else
            echo "‚ö†Ô∏è  win_probability_predictions_v2.json not found in data/"
          fi
          
          # Add season_2025_2026_team_stats.json if it exists
          if [ -f "data/season_2025_2026_team_stats.json" ]; then
            echo "üì¶ Adding season_2025_2026_team_stats.json..."
            git add --force data/season_2025_2026_team_stats.json
            FILES_TO_COMMIT="$FILES_TO_COMMIT data/season_2025_2026_team_stats.json"
            echo "‚úÖ season_2025_2026_team_stats.json added"
          else
            echo "‚ö†Ô∏è  season_2025_2026_team_stats.json not found in data/"
          fi
          
          # Commit if there are changes
          if ! git diff --staged --quiet; then
            echo "üìù Committing updated predictions, edge data, and team stats..."
            git commit -m "Update daily NHL predictions, edge data, and team stats - $(date -u +'%Y-%m-%d')"
            echo "‚úÖ Committed:$FILES_TO_COMMIT"
          else
            echo "‚ÑπÔ∏è  No changes to commit (files are up to date)"
          fi
      - name: Push edge data changes
        if: always()
        run: |
          # Only push if there are local commits ahead of origin
          git fetch origin main
          AHEAD=$(git rev-list --count origin/main..HEAD || echo 0)
          if [ "$AHEAD" -gt 0 ]; then
            git pull --rebase --autostash origin main
            git push origin HEAD:main
          else
            echo "No edge data changes to push"
          fi
