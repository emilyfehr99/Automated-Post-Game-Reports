name: NHL Post-Game Reports

on:
  schedule:
    # Weekends (Sat, Sun): 11 AM CT - 6 PM CT
    - cron: '*/20 17-23 * * 0,6'
    # Weekend Nights (6 PM CT - 3 AM CT) - Sun/Mon UTC
    - cron: '*/20 0-9 * * 0,1'
    # Weekday Nights (7 PM CT - 4 AM CT) - Tue-Sat UTC (Covers Mon-Fri nights)
    - cron: '*/20 1-9 * * 2-6'
  repository_dispatch:
    types: [game-finished]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  post_reports:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Check for games to process
      id: check
      run: |
        chmod +x fast_game_check.py
        if [[ "${{ github.event_name }}" != "schedule" ]]; then
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Manual or external trigger - proceeding"
        elif python3 fast_game_check.py; then
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "âœ… Games found or live - proceeding"
        else
          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ No new completed or live games found - skipping"
        fi

    - name: Install system dependencies
      if: steps.check.outputs.should_run == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y poppler-utils
    
    - name: Install dependencies
      if: steps.check.outputs.should_run == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Pull latest changes
      if: steps.check.outputs.should_run == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        git pull --rebase origin main || git pull origin main || true
        if [ ! -f processed_games.json ]; then
          echo '{"games": []}' > processed_games.json
          git add -f processed_games.json
        fi
    
    - name: Check for completed games and post
      if: steps.check.outputs.should_run == 'true'
      env:
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        python3 github_actions_runner.py
    
    - name: Commit processed games and tracking files
      if: steps.check.outputs.should_run == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        git pull --rebase origin main || git pull origin main || true
        
        if [ ! -f processed_games.json ]; then
          echo '{"games": []}' > processed_games.json
        fi
        
        if [ -f "season_2025_2026_team_stats.json" ]; then
          git add -f season_2025_2026_team_stats.json
        fi
        if [ -f "processed_games.json" ]; then
          git add -f processed_games.json
        fi
        if [ -f "win_probability_predictions_v2.json" ]; then
          git add -f win_probability_predictions_v2.json
        fi
        
        if ! git diff --staged --quiet; then
          git commit -m "Update processed games and model data [skip ci]"
          git push origin main
        fi
