name: Auto Post NHL Reports

on:
  schedule:
    # Smart scheduling - covers all game finish scenarios:
    # Most NHL games start 6-8pm CT, finish 2.5 hours later (8:30-10:30pm CT)
    # Late games (West Coast, OT) can finish 12am-2am CT
    # Weekdays: 8pm-3am CT (covers evening games + late finishers)
    # Weekends: 1pm-3am CT (covers afternoon/evening games + late finishers)
    # Peak Hours: Every 10 minutes from 6pm-3am CT (0-9 UTC)
    # Covers typical game finish times including West Coast & OT
    - cron: '*/10 0-9 * * *'
  repository_dispatch:  # Allow external triggers (instant when game finishes)
    types: [game-finished]  # Custom event type from game monitor
  workflow_dispatch:  # Allow manual triggering from Actions tab

jobs:
  check-and-post:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow workflow to commit and push
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history to ensure we have the latest commits
    
    - name: Check if any games are close to finishing
      id: game_check
      run: |
        # Fetch today's schedule (and yesterday's if it's early morning)
        export TZ='America/Chicago'
        today=$(date +%Y-%m-%d)
        current_hour=$(date +%H)
        
        echo "üîç Checking if any games are close to finishing..."
        
        # If it's early morning (12am-6am CT), also check yesterday's games
        # This catches late games (West Coast, OT) that finish after midnight
        dates_to_check="$today"
        if [ "$current_hour" -ge 0 ] && [ "$current_hour" -lt 6 ]; then
          yesterday=$(date -d "yesterday" +%Y-%m-%d 2>/dev/null || date -v-1d +%Y-%m-%d)
          dates_to_check="$yesterday $today"
          echo "   üìÖ Early morning detected - checking yesterday ($yesterday) and today ($today)"
        fi
        
        total_in_progress=0
        total_completed=0
        
        for check_date in $dates_to_check; do
          # Get schedule from NHL API
          response=$(curl -s "https://api-web.nhle.com/v1/schedule/${check_date}")
          
          # Check if any games are LIVE or recently finished
          games_in_progress=$(echo "$response" | grep -o '"gameState":"LIVE"' | wc -l)
          games_final=$(echo "$response" | grep -o '"gameState":"FINAL"' | wc -l)
          games_off=$(echo "$response" | grep -o '"gameState":"OFF"' | wc -l)
          
          completed_games=$((games_final + games_off))
          
          total_in_progress=$((total_in_progress + games_in_progress))
          total_completed=$((total_completed + completed_games))
          
          if [ "$games_in_progress" -gt 0 ] || [ "$completed_games" -gt 0 ]; then
            echo "   üìä $check_date: $games_in_progress live, $completed_games completed"
          fi
        done
        
        if [ "$total_in_progress" -gt 0 ]; then
          echo "‚úÖ PROCEED: $total_in_progress game(s) currently in progress"
          echo "should_run=true" >> $GITHUB_OUTPUT
        elif [ "$total_completed" -gt 0 ]; then
          echo "‚úÖ PROCEED: $total_completed finished game(s) to process"
          echo "should_run=true" >> $GITHUB_OUTPUT
        else
          echo "‚è≠Ô∏è  SKIP: No games in progress or finished"
          echo "should_run=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Set up Python
      if: steps.game_check.outputs.should_run == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      if: steps.game_check.outputs.should_run == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y poppler-utils
    
    - name: Install dependencies
      if: steps.game_check.outputs.should_run == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Pull latest changes (ensure we have latest processed_games.json)
      if: steps.game_check.outputs.should_run == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        # Pull latest to get any updates to processed_games.json from previous runs
        git pull --rebase origin main || git pull origin main || true
        # Ensure processed_games.json exists
        if [ ! -f processed_games.json ]; then
          echo '{"games": []}' > processed_games.json
          git add -f processed_games.json
        fi
        echo "üìã Current processed_games.json status:"
        if [ -f processed_games.json ]; then
          cat processed_games.json || echo "  (file exists but could not read)"
        else
          echo "  (file does not exist)"
        fi
    
    - name: Check for completed games and post
      if: steps.game_check.outputs.should_run == 'true'
      env:
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
      run: |
        python3 github_actions_runner.py
    
    - name: Commit processed games, team stats, and model learning data
      if: steps.game_check.outputs.should_run == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        
        # Pull latest changes to avoid conflicts (in case another run committed)
        git pull --rebase origin main || git pull origin main || true
        
        # Ensure processed_games.json exists (create empty if missing)
        if [ ! -f processed_games.json ]; then
          echo '{"games": []}' > processed_games.json
        fi
        
        # Force add files that are in .gitignore but need to be tracked
        # Team stats is updated by daily predictions workflow at 6am CT, so we just commit it if it exists
        if [ -f "season_2025_2026_team_stats.json" ]; then
          git add -f season_2025_2026_team_stats.json
        fi
        # Add other files
        if [ -f "processed_games.json" ]; then
          git add -f processed_games.json
        fi
        if [ -f "win_probability_predictions_v2.json" ]; then
          git add -f win_probability_predictions_v2.json
        fi
        
        # Check if there are changes to commit
        if ! git diff --staged --quiet; then
          echo "üìù Committing updated tracking files..."
          git commit -m "Update processed games, team stats, and model learning data [skip ci]"
          git push origin main
          echo "‚úÖ Successfully committed and pushed tracking files"
        else
          echo "‚ÑπÔ∏è  No changes to commit (files are up to date)"
        fi
        
        # Verify the file is tracked in git
        if git ls-files --error-unmatch processed_games.json > /dev/null 2>&1; then
          echo "‚úÖ processed_games.json is tracked in git"
        else
          echo "‚ö†Ô∏è  WARNING: processed_games.json is not tracked in git!"
        fi

